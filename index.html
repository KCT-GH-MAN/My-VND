<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Qu·∫£n l√Ω Chi ti√™u - My VNƒê
	</title>
<!-- Th∆∞ vi·ªán v·∫Ω bi·ªÉu ƒë·ªì & xu·∫•t Excel -->
<script defer="defer" src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
        :root {
            --primary: #2563eb;
            --primary-soft: #e0ebff;
            --primary-soft2: #f3f6ff;
            --danger: #dc2626;
            --danger-dark: #b91c1c;
            --success: #22c55e;
            --warning: #f59e0b;
            --text-main: #111827;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --bg: #f3f4f6;
        }

        * {
            box-sizing: border-box;
        }

        body {
            -webkit-tap-highlight-color: transparent;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 720px;
            margin: 0 auto;
            padding: 16px 14px 40px;
            background: var(--bg);
            color: var(--text-main);
        }

        .app-shell {
            background: #ffffff;
            border-radius: 18px;
            box-shadow: 0 10px 40px rgba(15, 23, 42, 0.12);
            padding: 18px 16px 22px;
        }

        h1 {
            font-size: 22px;
            text-align: center;
            margin: 0 0 4px;
        }

        h2 {
            font-size: 16px;
            margin: 18px 0 10px;
        }

        h3 {
            font-size: 14px;
            margin: 10px 0 8px;
        }

        .app-credit {
            text-align: center;
            margin-bottom: 12px;
            font-size: 13px;
            color: var(--text-sub);
        }

        label {
            display: block;
            font-size: 13px;
            margin-bottom: 4px;
            color: #374151;
        }

        input,
        select {
            width: 100%;
            padding: 9px 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 14px;
            margin-bottom: 10px;
            background: #f9fafb;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.35);
            background: #ffffff;
        }

        button {
            border: none;
            border-radius: 999px;
            padding: 9px 15px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: var(--primary);
            color: white;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.2);
            transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.12s ease;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.25);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.15);
        }

        .btn-full {
            width: 100%;
        }

        .btn-ghost {
            background: #f9fafb;
            color: #374151;
            border: 1px solid var(--border);
            box-shadow: none;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: var(--danger-dark);
        }

        .btn-success {
            background: var(--success);
        }

        .section {
            margin-top: 18px;
            padding-top: 10px;
            border-top: 1px dashed #e5e7eb;
        }

        .section:first-of-type {
            border-top: none;
            margin-top: 0;
            padding-top: 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            flex-wrap: nowrap;
            gap: 6px;
            margin: 10px 0 6px;
            padding: 5px;
            background: #f3f4ff;
            border-radius: 999px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px 10px;
            border-radius: 999px;
            border: none;
            background: transparent;
            font-size: 13px;
            color: #4b5563;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            transition: background 0.15s ease, color 0.15s ease, transform 0.08s ease;
        }

        .tab-btn.active {
            background: var(--primary);                 /* n·ªÅn xanh */
            color: #ffffff;                             /* ch·ªØ tr·∫Øng */
            font-weight: 600;                           /* t√¥ ƒë·∫≠m */
            box-shadow: 0 3px 10px rgba(37, 99, 235, 0.35);
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
            margin-top: 6px;
        }

        .tab-content.active {
            display: block;
        }

        /* Danh s√°ch giao d·ªãch */
        #list,
        #filterList {
            max-height: 220px;
            overflow-y: auto;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 8px;
            background: #f9fafb;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            margin-bottom: 6px;
            border-radius: 10px;
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
            font-size: 13px;
        }

        .expense-main {
            flex: 1;
        }

        .expense-meta {
            font-size: 12px;
            color: var(--text-sub);
        }

        .item-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .amount-expense {
            color: var(--danger);
            font-weight: 600;
        }

        .amount-income {
            color: var(--success);
            font-weight: 600;
        }

        /* T·ªïng quan */
        .overview-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .overview-filters select,
        .overview-filters input {
            width: auto;
            min-width: 120px;
            margin-bottom: 0;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin: 2px 0;
        }

        .stat-row span.value {
            font-weight: 600;
        }

        /* Ng√¢n s√°ch */
        .budget-bar-wrapper {
            background: #e5e7eb;
            border-radius: 999px;
            height: 16px;
            overflow: hidden;
            margin-top: 6px;
        }

        .budget-bar {
            height: 100%;
            width: 0%;
            background: var(--success);
            transition: width 0.25s ease;
        }

        /* Bi·ªÉu ƒë·ªì tr√≤n + Legend */
        .pie-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #pieChart {
            width: 260px !important;
            height: 260px !important;
            max-width: 260px !important;
            max-height: 260px !important;
            margin-top: 12px;
        }

        .pie-legend {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 6px 12px;
            margin-top: 8px;
            font-size: 13px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
        }

        /* Modal (filter, export, edit) ‚Äì d·∫°ng trung t√¢m */
        .modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: flex-end;
            justify-content: center;
            background-color: rgba(15, 23, 42, 0.45);
            z-index: 50;
        }

        .modal-content {
            width: 100%;
            max-width: 480px;
            margin: 0 auto 8px;
            background-color: #ffffff;
            border-radius: 20px 20px 14px 14px;
            padding: 14px 14px 16px;
            box-shadow: 0 -6px 30px rgba(15, 23, 42, 0.45);
            animation: slideUp 0.18s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .modal-title {
            font-size: 15px;
            font-weight: 600;
        }

        .close {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 18px;
            color: #6b7280;
        }

        .bottom-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }

        .bottom-actions .btn-full {
            flex: 1;
        }

        @keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Thanh h√†nh ƒë·ªông nguy hi·ªÉm */
        .danger-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .danger-actions button {
            flex: 1;
        }

        /* Responsive */
        @media (max-width: 600px) {
            body {
                padding: 10px 8px 26px;
            }
            .app-shell {
                border-radius: 16px;
                padding: 14px 11px 18px;
            }
            #list,
            #filterList {
                max-height: 260px;
            }
            .pie-legend {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .overview-filters {
                flex-direction: column;
                align-items: flex-start;
            }
            .overview-filters select,
            .overview-filters input {
                width: 100%;
            }
        }
    
        /* CƒÉn gi·ªØa Legend c·ªßa Ng√¢n s√°ch */
        #budgetLegend {
            display: flex !important;
            justify-content: center !important;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

    
        /* Fix legend Ng√¢n s√°ch lu√¥n vu√¥ng + bo tr√≤n */
        #budgetLegend .legend-color {
            width: 14px !important;
            height: 14px !important;
            border-radius: 4px !important;
            flex-shrink: 0;
            display: inline-block;
        }

    
        /* Force legend items to not stretch and keep square colors */
        #budgetLegend {
            align-items: center !important;
        }
        #budgetLegend .legend-item {
            align-items: center !important;
        }
        #budgetLegend .legend-color {
            width: 14px !important;
            height: 14px !important;
            min-width:14px !important;
            min-height:14px !important;
            border-radius: 4px !important;
            display:inline-block !important;
        }

    
        /* Budget legend standalone flexbox */
        .budget-legend {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            flex-wrap: wrap !important;
            gap: 12px !important;
            margin-top: 12px !important;
        }
        .budget-legend .legend-item {
            display:flex !important;
            align-items:center !important;
            gap:6px;
        }
        .budget-legend .legend-color {
            width:14px !important;
            height:14px !important;
            border-radius:4px !important;
            min-width:14px !important;
            min-height:14px !important;
            display:inline-block !important;
        }

    
        /* Popup alert/confirm */
        .app-alert-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .app-alert-dialog {
            background: #ffffff;
            border-radius: 16px;
            padding: 16px 20px;
            max-width: 340px;
            width: calc(100% - 48px);
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.25);
            text-align: center;
            font-size: 14px;
        }
        .app-alert-message {
            margin-bottom: 12px;
            line-height: 1.5;
        }
        .app-alert-actions {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
        }
        .app-alert-button {
            padding: 8px 18px;
            border-radius: 999px;
            border: none;
            background: #2563eb;
            color: #ffffff;
            font-weight: 600;
            cursor: pointer;
        }
        .app-alert-button-secondary {
            background: #e5e7eb;
            color: #111827;
        }
        .app-alert-button:active {
            transform: translateY(1px);
        }
</style>
<!-- WEB MANIFEST (PWA ICON + NAME) -->
<link rel="manifest" href="/manifest.webmanifest">
<!-- APP ICON -->
<link rel="icon" type="image/png" href="/icon-192.png">
<link rel="apple-touch-icon" href="/icon-192.png">



<!-- APP THEME FOR MOBILE -->
<meta name="theme-color" content="#0f172a" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

</head>
<body>
<div class="app-shell">
<h1>Qu·∫£n l√Ω Chi ti√™u</h1>
<p class="app-credit">Made with ‚ù§Ô∏è‚Äçüî• by <strong>PhamKCT</strong></p>
<!-- Tabs -->
<div class="tabs">
<button class="tab-btn active" data-tab="tab-giao-dich">üí∏ Giao d·ªãch</button>
<button class="tab-btn" data-tab="tab-bao-cao">üìä B√°o c√°o</button>
<button class="tab-btn" data-tab="tab-ngan-sach">üéØ Ng√¢n s√°ch &amp; Th·ªëng k√™ </button>
</div>
<!-- TAB 1: GIAO D·ªäCH -->
<div class="tab-content active" id="tab-giao-dich">
<!-- Th√™m giao d·ªãch -->
<div class="section">
<h2>Th√™m giao d·ªãch</h2>
<label for="date">Ng√†y</label>
<input id="date" type="date"/>
<label for="amount">S·ªë ti·ªÅn</label>
<input autocomplete="off" id="amount" inputmode="decimal" pattern="[0-9]*" placeholder="0" type="text"/>
<label for="type">Lo·∫°i giao d·ªãch</label>
<select id="type">
<option>Chi ti√™u</option>
<option>Thu nh·∫≠p</option>
</select>
<label for="category">Nh√≥m</label>
<select id="category">
<option>ƒÇn u·ªëng</option>
<option>ƒêi l·∫°i</option>
<option>Mua s·∫Øm</option>
<option>Gi·∫£i tr√≠</option>
<option>ƒê·∫ßu t∆∞/Ti·∫øt ki·ªám</option>
<option>Kh√°c</option>
</select>
<label for="note">Ghi ch√∫</label>
<input id="note" placeholder="vd: caf√© s√°ng" type="text"/>
<button class="btn-full" id="btnAdd">‚ûï Th√™m giao d·ªãch</button>
</div>
<!-- Danh s√°ch giao d·ªãch -->
<div class="section">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
<h2 style="margin:0;">Danh s√°ch giao d·ªãch</h2>
<button class="btn-ghost" id="btnFilterQuick">üîç L·ªçc n√¢ng cao</button>
</div>
<div id="list"></div>
<div class="danger-actions">
<button class="btn-success" id="btnExport">üì§ Xu·∫•t d·ªØ li·ªáu</button>
<button class="btn-danger" id="btnClearAll">üóëÔ∏è X√≥a to√†n b·ªô d·ªØ li·ªáu</button>
</div>
</div>
<!-- T·ªïng quan -->
<div class="section">
<h2>T·ªïng quan</h2>
<div class="overview-filters">
<span>Ph·∫°m vi:</span>
<select id="overviewModeSelect">
<option selected="" value="all">T·∫•t c·∫£ d·ªØ li·ªáu</option>
<option value="today">H√¥m nay</option>
<option value="day">Ng√†y b·∫•t k·ª≥</option>
<option value="month">Th√°ng b·∫•t k·ª≥</option>
<option value="year">NƒÉm b·∫•t k·ª≥</option>
<option value="range">Giai ƒëo·∫°n b·∫•t k·ª≥</option>
</select>
<input id="overviewDay" style="display:none" type="date"/>
<input id="overviewMonth" style="display:none" type="month"/>
<input id="overviewYear" max="2100" min="2000" style="display:none;width:90px;" type="number"/>
<input id="overviewFrom" style="display:none" type="date"/>
<span id="overviewRangeSeparator" style="display:none;">‚Üí</span>
<input id="overviewTo" style="display:none" type="date"/>
</div>
<p id="overviewLabelText" style="font-style:italic;margin-bottom:6px;">
                Ph·∫°m vi: T·∫•t c·∫£ d·ªØ li·ªáu
            </p>
<div class="stat-row">
<span>T·ªïng thu:</span>
<span class="value" id="totalIncome">0 ƒë</span>
</div>
<div class="stat-row">
<span>T·ªïng chi:</span>
<span class="value" id="totalExpense">0 ƒë</span>
</div>
<div class="stat-row">
<span>S·ªë d∆∞:</span>
<span class="value" id="balance">0 ƒë</span>
</div>
</div>
</div>
<!-- TAB 2: B√ÅO C√ÅO -->
<div class="tab-content" id="tab-bao-cao">
<div class="section">
<div style="margin-top:0;background:#f3f4ff;padding:10px;border-radius:12px;">
<h3 style="margin-top:0;">L·ªçc bi·ªÉu ƒë·ªì</h3>
<label for="pieFilterMode">Ch·∫ø ƒë·ªô l·ªçc</label>
<select id="pieFilterMode">
<option value="all">To√†n b·ªô d·ªØ li·ªáu</option>
<option value="year">Theo nƒÉm</option>
<option value="month">Theo th√°ng</option>
<option value="range">Kho·∫£ng ng√†y t√πy ch·ªçn</option>
</select>
<div id="pieFilterYear" style="display:none;margin-top:6px;">
<label for="pieYear">NƒÉm</label>
<input id="pieYear" type="number" value="2025"/>
</div>
<div id="pieFilterMonth" style="display:none;margin-top:6px;">
<label for="pieMonthYear">NƒÉm</label>
<input id="pieMonthYear" type="number" value="2025"/>
<label for="pieMonth">Th√°ng</label>
<input id="pieMonth" max="12" min="1" type="number" value="1"/>
</div>
<div id="pieFilterRange" style="display:none;margin-top:6px;">
<label for="pieFrom">T·ª´ ng√†y</label>
<input id="pieFrom" type="date"/>
<label for="pieTo">ƒê·∫øn ng√†y</label>
<input id="pieTo" type="date"/>
</div>
</div>
<div class="pie-container">
<canvas id="pieChart"></canvas>
<div class="pie-legend" id="pieLegend"></div>
</div>
</div>
<div class="section">
<h2>Bi·ªÉu ƒë·ªì Thu - Chi theo t·ª´ng th√°ng</h2>
<div style="margin-top:4px;margin-bottom:4px;font-size:13px;color:var(--text-sub);">
    NƒÉm: <input id="monthChartYear" type="number" min="2000" max="2100" style="width:90px;padding:4px 6px;border-radius:6px;border:1px solid var(--border);" />
</div>
<canvas id="monthChart" style="margin-top:6px;"></canvas>
<p id="monthChartSummary" style="margin-top:6px;font-size:13px;color:var(--text-sub);"></p>
</div>
<div class="section">
<h2>K·∫øt qu·∫£ l·ªçc</h2>
<p id="filterSummary">Ch∆∞a √°p d·ª•ng b·ªô l·ªçc.</p>
<div id="filterList" style="margin-top:6px;"></div>
<p id="filterTotals" style="margin-top:6px;font-weight:600;"></p>
</div>
</div>
<!-- TAB 3: NG√ÇN S√ÅCH & TH·ªêNG K√ä -->
<div class="tab-content" id="tab-ngan-sach">
<div class="section">
<h2>Ng√¢n s√°ch (ch·ªâ CHI TI√äU)</h2>
<label for="budgetMode">Lo·∫°i ng√¢n s√°ch</label>
<select id="budgetMode">
<option value="day">Theo ng√†y</option>
<option selected="" value="month">Theo th√°ng</option>
<option value="year">Theo nƒÉm</option>
</select>
<div class="budget-picker" id="budgetPickerDay">
<label for="budgetDay">Ng√†y √°p d·ª•ng</label>
<input id="budgetDay" type="date"/>
</div>
<div class="budget-picker" id="budgetPickerMonth">
<label for="budgetMonth">Th√°ng √°p d·ª•ng</label>
<input id="budgetMonth" type="month"/>
</div>
<div class="budget-picker" id="budgetPickerYear">
<label for="budgetYear">NƒÉm √°p d·ª•ng</label>
<input id="budgetYear" max="2100" min="2000" type="number"/>
</div>
<p id="budgetMonthLabel" style="font-size:13px;color:var(--text-sub);margin-top:4px;"></p>
<label for="budgetAmount">S·ªë ti·ªÅn ng√¢n s√°ch</label>
<input autocomplete="off" id="budgetAmount" inputmode="decimal" pattern="[0-9]*" placeholder="0" type="text"/>
<button class="btn-full" id="btnSaveBudget">üíæ L∆∞u ng√¢n s√°ch</button>
<p id="budgetSummary" style="margin-top:6px;font-size:13px;"></p>
<div class="budget-bar-wrapper">
<div class="budget-bar" id="budgetBar"></div>
</div>
<canvas id="budgetChart" style="max-width:360px;margin:12px auto 0;display:block;"></canvas>
<div id="budgetLegend" class="budget-legend"></div>
</div>
<div class="section">
<h2>Th·ªëng k√™ nhanh (CH·ªà chi ti√™u)</h2>
<div class="stat-row">
<span>Chi h√¥m nay:</span>
<span class="value" id="todayTotal">0 ƒë</span>
</div>
<div class="stat-row">
<span>Chi tu·∫ßn n√†y:</span>
<span class="value" id="weekTotal">0 ƒë</span>
</div>
<div class="stat-row">
<span>Chi th√°ng n√†y:</span>
<span class="value" id="monthTotal">0 ƒë</span>
</div>
</div>
</div>
</div>
<!-- MODAL: Xu·∫•t d·ªØ li·ªáu -->
<div class="modal" id="exportModal">
<div class="modal-content">
<div class="modal-header">
<span class="modal-title">Xu·∫•t d·ªØ li·ªáu ra Excel</span>
<span class="close" data-close="exportModal">‚úï</span>
</div>
<p style="font-size:13px;margin-bottom:8px;">Ch·ªçn kho·∫£ng th·ªùi gian (ƒë·ªÉ tr·ªëng = xu·∫•t d·ªØ li·ªáu th√°ng hi·ªán t·∫°i):</p>
<label for="exportFrom">T·ª´ ng√†y</label>
<input id="exportFrom" type="date"/>
<label for="exportTo">ƒê·∫øn ng√†y</label>
<input id="exportTo" type="date"/>
<div class="bottom-actions">
<button class="btn-ghost btn-full" data-close="exportModal">H·ªßy</button>
<button class="btn-success btn-full" id="btnExportConfirm">üì§ Xu·∫•t Excel</button>
</div>
</div>
</div>
<!-- MODAL: L·ªçc n√¢ng cao -->
<div class="modal" id="filterModal">
<div class="modal-content">
<div class="modal-header">
<span class="modal-title">L·ªçc n√¢ng cao</span>
<span class="close" data-close="filterModal">‚úï</span>
</div>
<label for="filterFrom">T·ª´ ng√†y</label>
<input id="filterFrom" type="date"/>
<label for="filterTo">ƒê·∫øn ng√†y</label>
<input id="filterTo" type="date"/>
<label for="filterType">Lo·∫°i giao d·ªãch</label>
<select id="filterType">
<option value="T·∫•t c·∫£">T·∫•t c·∫£</option>
<option value="Chi ti√™u">Chi ti√™u</option>
<option value="Thu nh·∫≠p">Thu nh·∫≠p</option>
</select>
<label for="filterCategory">Nh√≥m</label>
<select id="filterCategory">
<option value="T·∫•t c·∫£">T·∫•t c·∫£</option>
<option>ƒÇn u·ªëng</option>
<option>ƒêi l·∫°i</option>
<option>Mua s·∫Øm</option>
<option>Gi·∫£i tr√≠</option>
<option>ƒê·∫ßu t∆∞/Ti·∫øt ki·ªám</option>
<option>Kh√°c</option>
</select>
<div class="bottom-actions">
<button class="btn-ghost btn-full" data-close="filterModal">ƒê√≥ng</button>
<button class="btn-full" id="btnApplyFilter">√Åp d·ª•ng</button>
</div>
</div>
</div>
<!-- MODAL: S·ª≠a giao d·ªãch -->
<div class="modal" id="editModal">
<div class="modal-content">
<div class="modal-header">
<span class="modal-title">S·ª≠a giao d·ªãch</span>
<span class="close" data-close="editModal">‚úï</span>
</div>
<label for="editDate">Ng√†y</label>
<input id="editDate" type="date"/>
<label for="editAmount">S·ªë ti·ªÅn</label>
<input autocomplete="off" id="editAmount" inputmode="decimal" pattern="[0-9]*" placeholder="0" type="text"/>
<label for="editType">Lo·∫°i giao d·ªãch</label>
<select id="editType">
<option>Chi ti√™u</option>
<option>Thu nh·∫≠p</option>
</select>
<label for="editCategory">Nh√≥m</label>
<select id="editCategory">
<option>ƒÇn u·ªëng</option>
<option>ƒêi l·∫°i</option>
<option>Mua s·∫Øm</option>
<option>Gi·∫£i tr√≠</option>
<option>ƒê·∫ßu t∆∞/Ti·∫øt ki·ªám</option>
<option>Kh√°c</option>
</select>
<label for="editNote">Ghi ch√∫</label>
<input id="editNote" type="text"/>
<div class="bottom-actions">
<button class="btn-ghost btn-full" data-close="editModal">H·ªßy</button>
<button class="btn-full" id="btnSaveEdit">L∆∞u thay ƒë·ªïi</button>
</div>
</div>
</div>
<script>
    // ====== DATA & STATE ======
    let expenses = JSON.parse(localStorage.getItem("expenses")) || [];
    let budgets = JSON.parse(localStorage.getItem("budgets")) || {};
    let editingIndex = null;
    let overviewMode = "all";

    let pieChart = null;
    let monthChart = null;
    let budgetChart = null;

    // Tr·∫°ng th√°i: c√≥ ƒëang d√πng d·ªØ li·ªáu t·ª´ L·ªçc n√¢ng cao cho bi·ªÉu ƒë·ªì kh√¥ng
    let useAdvancedFilterForPie = false;
    let lastAdvancedFilterList = null;

    // ====== DANH M·ª§C: C∆† B·∫¢N + T√ôY CH·ªàNH ======
    const baseCategories = [
        "ƒÇn u·ªëng",
        "ƒêi l·∫°i",
        "Mua s·∫Øm",
        "Gi·∫£i tr√≠",
        "ƒê·∫ßu t∆∞/Ti·∫øt ki·ªám",
        "Kh√°c"
    ];
    let extraCategories = [];
    try {
        const savedCats = localStorage.getItem("extraCategories");
        if (savedCats) {
            extraCategories = JSON.parse(savedCats) || [];
        }
    } catch (e) {
        extraCategories = [];
    }

    function saveExtraCategories() {
        try {
            localStorage.setItem("extraCategories", JSON.stringify(extraCategories));
        } catch (e) {}
    }

    function refreshCategorySelects() {
        const categorySelect = $("category");
        const editCategorySelect = $("editCategory");
        const filterCategorySelect = $("filterCategory");

        // Gi·ªØ c√°c danh m·ª•c c∆° b·∫£n + danh m·ª•c t√πy ch·ªânh ƒë√£ l∆∞u
        const allCats = baseCategories.concat(extraCategories);

        function rebuildSelect(sel, opts, { withAll = false } = {}) {
            if (!sel) return;
            const current = sel.value;
            sel.innerHTML = "";

            if (withAll) {
                const optAll = document.createElement("option");
                optAll.value = "T·∫•t c·∫£";
                optAll.textContent = "T·∫•t c·∫£";
                sel.appendChild(optAll);
            }

            opts.forEach((cat) => {
                const o = document.createElement("option");
                o.value = cat;
                o.textContent = cat;
                sel.appendChild(o);
            });

            if (current && Array.from(sel.options).some((o) => o.value === current)) {
                sel.value = current;
            }
        }

        // √î Nh√≥m khi th√™m/s·ª≠a giao d·ªãch: ch·ªâ hi·ªán danh m·ª•c, KH√îNG c√≤n "Th√™m m·ªõi / X√≥a"
        rebuildSelect(categorySelect, allCats);
        rebuildSelect(editCategorySelect, allCats);

        // √î Nh√≥m trong L·ªçc n√¢ng cao: c√≥ th√™m l·ª±a ch·ªçn "T·∫•t c·∫£"
        rebuildSelect(filterCategorySelect, allCats, { withAll: true });
    }


    function addNewCategory(name, preferSelectId) {
        const trimmed = (name || "").trim();
        if (!trimmed) return;

        // n·∫øu ƒë√£ t·ªìn t·∫°i th√¨ ch·ªâ ch·ªçn l·∫°i
        if (baseCategories.includes(trimmed) || extraCategories.includes(trimmed)) {
            refreshCategorySelects();
            const sel = $(preferSelectId);
            if (sel) sel.value = trimmed;
            return;
        }

        extraCategories.push(trimmed);
        saveExtraCategories();
        refreshCategorySelects();
        const sel = $(preferSelectId);
        if (sel) sel.value = trimmed;
    }

    
    
    function initCategoryNewHandler(selectId) {
        const sel = $(selectId);
        if (!sel) return;

        // L∆∞u l·∫°i l·ª±a ch·ªçn g·∫ßn nh·∫•t (kh√¥ng ph·∫£i option ƒë·∫∑c bi·ªát)
        sel.dataset.lastCategory = sel.value;

        sel.addEventListener("change", function () {
            const currentVal = this.value;

            if (currentVal === "__new__") {
                const newName = prompt("Nh·∫≠p t√™n danh m·ª•c m·ªõi:");
                if (!newName) {
                    if (this.options.length > 0) this.selectedIndex = 0;
                    return;
                }
                addNewCategory(newName, selectId);
                return;
            }

            if (currentVal === "__delete__") {
                const catToDelete = this.dataset.lastCategory;
                if (!catToDelete) {
                    showAlert("Ch∆∞a c√≥ danh m·ª•c n√†o ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ x√≥a.");
                } else if (baseCategories.includes(catToDelete)) {
                    showAlert("Kh√¥ng th·ªÉ x√≥a c√°c danh m·ª•c m·∫∑c ƒë·ªãnh.");
                } else if (!extraCategories.includes(catToDelete)) {
                    showAlert("Danh m·ª•c n√†y kh√¥ng n·∫±m trong danh s√°ch t√πy ch·ªânh.");
                } else {
                    showConfirm(
                        "X√≥a danh m·ª•c '" +
                            catToDelete +
                            "'? T·∫§T C·∫¢ c√°c giao d·ªãch ƒëang d√πng danh m·ª•c n√†y s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn.",
                        () => {
                            // X√≥a kh·ªèi danh s√°ch danh m·ª•c t√πy ch·ªânh
                            extraCategories = extraCategories.filter((c) => c !== catToDelete);
                            saveExtraCategories();

                            // X√≥a to√†n b·ªô giao d·ªãch c√≥ category = catToDelete
                            if (Array.isArray(expenses)) {
                                const before = expenses.length;
                                expenses = expenses.filter((item) => item.category !== catToDelete);
                                if (expenses.length !== before) {
                                    try {
                                        localStorage.setItem("expenses", JSON.stringify(expenses));
                                    } catch (e) {}
                                }
                            }

                            // L√†m m·ªõi dropdown + giao di·ªán
                            refreshCategorySelects();
                            if (typeof renderAll === "function") {
                                renderAll();
                            }

                            showAlert(
                                "ƒê√£ x√≥a danh m·ª•c '" +
                                    catToDelete +
                                    "' v√† T·∫§T C·∫¢ c√°c giao d·ªãch thu·ªôc danh m·ª•c n√†y."
                            );
                        }
                    );
                }
                // Sau khi x·ª≠ l√Ω x√≥a, quay v·ªÅ l·ª±a ch·ªçn ƒë·∫ßu ti√™n
                if (this.options.length > 0) this.selectedIndex = 0;
                this.dataset.lastCategory = this.value;
                return;
            }

            // C·∫≠p nh·∫≠t l·ª±a ch·ªçn b√¨nh th∆∞·ªùng
            this.dataset.lastCategory = currentVal;
        });
    }

    // ====== UTIL ======
    const $ = (id) => document.getElementById(id);
    // Popup alert/confirm replacement for window.alert / window.confirm
    function showAlert(message) {
        const overlay = document.getElementById("appAlertOverlay");
        const msgEl = document.getElementById("appAlertMessage");
        const okBtn = document.getElementById("appAlertOk");
        const cancelBtn = document.getElementById("appAlertCancel");

        if (!overlay || !msgEl || !okBtn || !cancelBtn) {
            window.alert(message);
            return;
        }

        msgEl.innerHTML = message;
        // alert: only OK button
        cancelBtn.style.display = "none";
        overlay.style.display = "flex";

        const hide = () => {
            overlay.style.display = "none";
            okBtn.removeEventListener("click", handleOk);
            overlay.removeEventListener("click", overlayHandler);
        };

        const handleOk = () => {
            hide();
        };

        const overlayHandler = (e) => {
            if (e.target === overlay) hide();
        };

        okBtn.addEventListener("click", handleOk);
        overlay.addEventListener("click", overlayHandler);
    }

    function showConfirm(message, onConfirm) {
        const overlay = document.getElementById("appAlertOverlay");
        const msgEl = document.getElementById("appAlertMessage");
        const okBtn = document.getElementById("appAlertOk");
        const cancelBtn = document.getElementById("appAlertCancel");

        if (!overlay || !msgEl || !okBtn || !cancelBtn) {
            const ok = window.confirm(message);
            if (ok && typeof onConfirm === "function") onConfirm();
            return;
        }

        msgEl.innerHTML = message;
        // confirm: show both buttons
        cancelBtn.style.display = "inline-block";
        overlay.style.display = "flex";

        const hide = () => {
            overlay.style.display = "none";
            okBtn.removeEventListener("click", handleOk);
            cancelBtn.removeEventListener("click", handleCancel);
            overlay.removeEventListener("click", overlayHandler);
        };

        const handleOk = () => {
            hide();
            if (typeof onConfirm === "function") onConfirm();
        };

        const handleCancel = () => {
            hide();
        };

        const overlayHandler = (e) => {
            if (e.target === overlay) hide();
        };

        okBtn.addEventListener("click", handleOk);
        cancelBtn.addEventListener("click", handleCancel);
        overlay.addEventListener("click", overlayHandler);
    }


    function cleanNumericString(str) {
        if (!str) return "";
        return String(str).replace(/\D/g, "");
    }

    function formatWithDots(numStr) {
        if (!numStr) return "";
        numStr = cleanNumericString(numStr);
        if (!numStr) return "";
        return numStr.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function formatCurrency(n) {
        return Number(n || 0).toLocaleString("vi-VN") + " ƒë";
    }

    function getTodayString() {
        const t = new Date();
        const m = String(t.getMonth() + 1).padStart(2, "0");
        const d = String(t.getDate()).padStart(2, "0");
        return `${t.getFullYear()}-${m}-${d}`;
    }

    function parseDate(str) {
        const [y, m, d] = str.split("-").map(Number);
        return new Date(y, m - 1, d);
    }

    function formatDateVN(isoDate) {
        if (!isoDate) return "";
        const [y, m, d] = isoDate.split("-");
        return `${d}/${m}/${y}`;
    }

    function isExpense(item) {
        return !item.type || item.type === "Chi ti√™u";
    }

    function isIncome(item) {
        return item.type === "Thu nh·∫≠p";
    }

    // ====== TABS ======
    document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
            const tabId = btn.dataset.tab;
            document.querySelectorAll(".tab-btn").forEach((b) =>
                b.classList.remove("active")
            );
            document.querySelectorAll(".tab-content").forEach((c) =>
                c.classList.remove("active")
            );
            btn.classList.add("active");
            $(tabId).classList.add("active");

            if (tabId === "tab-bao-cao") {
                if (useAdvancedFilterForPie && lastAdvancedFilterList) {
                    renderPieChartFiltered(lastAdvancedFilterList);
                } else {
                    renderPieChartFiltered();
                }
                renderByMonth();
            }
            if (tabId === "tab-ngan-sach") {
                renderBudget();
                renderQuickStats();
            }
        });
    });

    // ====== OVERVIEW FILTERS ======
    function isInOverviewPeriod(item) {
        const d = parseDate(item.date);
        switch (overviewMode) {
            case "today":
                return item.date === getTodayString();
            case "day": {
                const dayStr = $("overviewDay").value;
                if (!dayStr) return true;
                return item.date === dayStr;
            }
            case "month": {
                const monthStr = $("overviewMonth").value;
                if (!monthStr) return true;
                const [yStr, mStr] = monthStr.split("-");
                const y = Number(yStr),
                    m = Number(mStr);
                return d.getFullYear() === y && d.getMonth() + 1 === m;
            }
            case "year": {
                const yearVal = Number($("overviewYear").value);
                if (!yearVal) return true;
                return d.getFullYear() === yearVal;
            }
            case "range": {
                const fromStr = $("overviewFrom").value;
                const toStr = $("overviewTo").value;
                if (!fromStr && !toStr) return true;
                if (fromStr && d < parseDate(fromStr)) return false;
                if (toStr && d > parseDate(toStr)) return false;
                return true;
            }
            default:
                return true;
        }
    }

    function getOverviewLabel() {
        switch (overviewMode) {
            case "today":
                return "Ph·∫°m vi: H√¥m nay";
            case "day": {
                const v = $("overviewDay").value;
                return v
                    ? "Ph·∫°m vi: Ng√†y " + formatDateVN(v)
                    : "Ph·∫°m vi: Ng√†y b·∫•t k·ª≥";
            }
            case "month": {
                const v = $("overviewMonth").value;
                if (!v) return "Ph·∫°m vi: Th√°ng b·∫•t k·ª≥";
                const [y, m] = v.split("-");
                return `Ph·∫°m vi: Th√°ng ${m}/${y}`;
            }
            case "year": {
                const v = $("overviewYear").value;
                return v ? "Ph·∫°m vi: NƒÉm " + v : "Ph·∫°m vi: NƒÉm b·∫•t k·ª≥";
            }
            case "range": {
                const fromStr = $("overviewFrom").value;
                const toStr = $("overviewTo").value;
                if (!fromStr && !toStr) return "Ph·∫°m vi: Giai ƒëo·∫°n b·∫•t k·ª≥";
                if (fromStr && toStr)
                    return `Ph·∫°m vi: T·ª´ ${formatDateVN(
                        fromStr
                    )} ƒë·∫øn ${formatDateVN(toStr)}`;
                if (fromStr) return `Ph·∫°m vi: T·ª´ ${formatDateVN(fromStr)}`;
                return `Ph·∫°m vi: ƒê·∫øn ${formatDateVN(toStr)}`;
            }
            default:
                return "Ph·∫°m vi: T·∫•t c·∫£ d·ªØ li·ªáu";
        }
    }

    function setOverviewMode(mode) {
        overviewMode = mode;
        const day = $("overviewDay");
        const month = $("overviewMonth");
        const year = $("overviewYear");
        const from = $("overviewFrom");
        const to = $("overviewTo");
        const sep = $("overviewRangeSeparator");

        day.style.display = mode === "day" ? "inline-block" : "none";
        month.style.display = mode === "month" ? "inline-block" : "none";
        year.style.display = mode === "year" ? "inline-block" : "none";

        const rangeActive = mode === "range";
        from.style.display = rangeActive ? "inline-block" : "none";
        to.style.display = rangeActive ? "inline-block" : "none";
        sep.style.display = rangeActive ? "inline-block" : "none";

        const todayStr = getTodayString();
        const today = new Date();

        if (mode === "day" && !day.value) {
            day.value = todayStr;
        } else if (mode === "month" && !month.value) {
            month.value = `${today.getFullYear()}-${String(
                today.getMonth() + 1
            ).padStart(2, "0")}`;
        } else if (mode === "year" && !year.value) {
            year.value = today.getFullYear();
        } else if (mode === "range") {
            if (!from.value) from.value = todayStr;
            if (!to.value) to.value = todayStr;
        }

        renderTotal();
    }

    // ====== RENDER LIST ======
    function renderList() {
        const list = $("list");
        list.innerHTML = "";
        if (!expenses.length) {
            list.innerHTML =
                '<p style="font-size:13px;color:#6b7280;margin:4px 0;">Ch∆∞a c√≥ giao d·ªãch n√†o.</p>';
            return;
        }

        const items = expenses
            .map((item, index) => ({ item, index }))
            .reverse();

        const frag = document.createDocumentFragment();

        items.forEach(({ item, index }) => {
            const isInc = isIncome(item);
            const sign = isInc ? "+" : "-";
            const amountClass = isInc ? "amount-income" : "amount-expense";
            const typeLabel = isInc ? "Thu nh·∫≠p" : "Chi ti√™u";
            const displayDate = formatDateVN(item.date);

            const row = document.createElement("div");
            row.className = "expense-item";

            const main = document.createElement("div");
            main.className = "expense-main";
            main.innerHTML = `
                <div class="${amountClass}">
                    ${sign} ${formatCurrency(item.amount)}
                </div>
                <div class="expense-meta">
                    ${displayDate} ‚Ä¢ ${typeLabel} ‚Ä¢ ${item.category}${
                item.note ? " ‚Ä¢ " + item.note : ""
            }
                </div>
            `;

            const actions = document.createElement("div");
            actions.className = "item-actions";

            const btnEdit = document.createElement("button");
            btnEdit.textContent = "S·ª≠a";
            btnEdit.className = "btn-ghost";
            btnEdit.style.fontSize = "12px";
            btnEdit.addEventListener("click", () => openEditModal(index));

            const btnDel = document.createElement("button");
            btnDel.textContent = "X√≥a";
            btnDel.className = "btn-danger";
            btnDel.style.fontSize = "12px";
            btnDel.addEventListener("click", () => deleteExpense(index));

            actions.appendChild(btnEdit);
            actions.appendChild(btnDel);

            row.appendChild(main);
            row.appendChild(actions);
            frag.appendChild(row);
        });

        list.appendChild(frag);
    }

    function renderTotal() {
        let totalIncome = 0;
        let totalExpense = 0;

        expenses.forEach((item) => {
            if (!isInOverviewPeriod(item)) return;
            const amount = Number(item.amount || 0);
            if (isIncome(item)) totalIncome += amount;
            else totalExpense += amount;
        });

        $("totalIncome").innerText = formatCurrency(totalIncome);
        $("totalExpense").innerText = formatCurrency(totalExpense);
        $("balance").innerText = formatCurrency(totalIncome - totalExpense);
        $("overviewLabelText").innerText = getOverviewLabel();
    }

    // ====== PIE CHART & REPORT ======
    function renderPieChartFiltered() {
        const mode = $("pieFilterMode").value;

        let filtered = expenses.filter((e) => isExpense(e));

        if (mode === "year") {
            const y = Number($("pieYear").value);
            filtered = filtered.filter(
                (e) => parseDate(e.date).getFullYear() === y
            );
        }

        if (mode === "month") {
            const y = Number($("pieMonthYear").value);
            const m = Number($("pieMonth").value) - 1;
            filtered = filtered.filter((e) => {
                const d = parseDate(e.date);
                return d.getFullYear() === y && d.getMonth() === m;
            });
        }

        if (mode === "range") {
            const f = $("pieFrom").value;
            const t = $("pieTo").value;
            filtered = filtered.filter((e) => {
                const d = parseDate(e.date);
                if (f && d < parseDate(f)) return false;
                if (t && d > parseDate(t)) return false;
                return true;
            });
        }

        // Gom d·ªØ li·ªáu theo danh m·ª•c (bao g·ªìm c·∫£ danh m·ª•c t·ª± th√™m)
        const totals = {};
        filtered.forEach((item) => {
            const cat = item.category || "Kh√°c";
            if (!totals[cat]) {
                totals[cat] = 0;
            }
            totals[cat] += Number(item.amount || 0);
        });

        const allKeys = Object.keys(totals);

        // Th·ª© t·ª± ∆∞u ti√™n: c√°c nh√≥m c∆° b·∫£n, sau ƒë√≥ l√† nh√≥m t·ª± t·∫°o, cu·ªëi c√πng lu√¥n l√† "Kh√°c"
        const baseOrder = [
            "ƒÇn u·ªëng",
            "ƒêi l·∫°i",
            "Mua s·∫Øm",
            "Gi·∫£i tr√≠",
            "ƒê·∫ßu t∆∞/Ti·∫øt ki·ªám"
        ];
        const labels = [];

        baseOrder.forEach((cat) => {
            if (allKeys.includes(cat) && totals[cat] > 0) {
                labels.push(cat);
            }
        });

        const otherCats = allKeys.filter(
            (c) => c !== "Kh√°c" && !baseOrder.includes(c) && totals[c] > 0
        );
        otherCats.forEach((cat) => labels.push(cat));

        if (allKeys.includes("Kh√°c") && totals["Kh√°c"] > 0) {
            labels.push("Kh√°c");
        }

        const data = labels.map((l) => totals[l]);

        // M√†u c·ªë ƒë·ªãnh cho c√°c nh√≥m c∆° b·∫£n, "Kh√°c" lu√¥n m√†u x√°m
        const baseColors = {
            "ƒÇn u·ªëng": "#3b82f6",
            "ƒêi l·∫°i": "#f97373",
            "Mua s·∫Øm": "#fb923c",
            "Gi·∫£i tr√≠": "#facc15",
            "ƒê·∫ßu t∆∞/Ti·∫øt ki·ªám": "#22c55e",
            Kh√°c: "#9ca3af",
        };

        // Palette cho c√°c danh m·ª•c t·ª± t·∫°o (Y t·∫ø, Gi√°o d·ª•c, v.v.)
        const extraPalette = ["#a855f7", "#06b6d4", "#ec4899", "#84cc16", "#0ea5e9"];

        const colors = [];
        let extraIndex = 0;
        labels.forEach((label) => {
            if (baseColors[label]) {
                colors.push(baseColors[label]);
            } else {
                colors.push(extraPalette[extraIndex % extraPalette.length]);
                extraIndex++;
            }
        });

        if (pieChart) pieChart.destroy();

        const ctx = $("pieChart").getContext("2d");
        pieChart = new Chart(ctx, {
            type: "pie",
            data: {
                labels,
                datasets: [
                    {
                        data,
                        backgroundColor: colors,
                    },
                ],
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                },
            },
        });

        const legendContainer = $("pieLegend");
        legendContainer.innerHTML = "";
        labels.forEach((label, idx) => {
            const color = colors[idx] || "#ccc";
            const div = document.createElement("div");
            div.className = "legend-item";
            div.innerHTML = `
                <span class="legend-color" style="background:${color}"></span>
                <span>${label}</span>
            `;
            legendContainer.appendChild(div);
        });

        // Text report (c√≥ th·ªÉ kh√¥ng hi·ªÉn th·ªã n·∫øu kh√¥ng t·ªìn t·∫°i #report)
        const report = $("report");
        if (report) {
            report.innerHTML = "";
            labels.forEach((label) => {
                const val = totals[label];
                if (!val) return;
                const p = document.createElement("p");
                p.style.fontSize = "13px";
                p.textContent = `${label}: ${formatCurrency(val)}`;
                report.appendChild(p);
            });
            if (!report.innerHTML) {
                report.innerHTML =
                    '<p style="font-size:13px;color:#6b7280;">Ch∆∞a c√≥ d·ªØ li·ªáu chi ti√™u ƒë·ªÉ hi·ªÉn th·ªã.</p>';
            }
        }
    }

    // ====== QUICK STATS ======
    function renderQuickStats() {
        const today = new Date();
        const todayStr = getTodayString();

        const dayOfWeek = today.getDay();
        const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() + diffToMonday);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);

        let todayTotal = 0;
        let weekTotal = 0;
        let monthTotal = 0;

        expenses.forEach((item) => {
            if (!isExpense(item)) return;
            const d = parseDate(item.date);
            const amount = Number(item.amount || 0);

            if (item.date === todayStr) todayTotal += amount;

            if (
                d >=
                    new Date(
                        startOfWeek.getFullYear(),
                        startOfWeek.getMonth(),
                        startOfWeek.getDate()
                    ) &&
                d <=
                    new Date(
                        endOfWeek.getFullYear(),
                        endOfWeek.getMonth(),
                        endOfWeek.getDate()
                    )
            ) {
                weekTotal += amount;
            }

            if (
                d.getFullYear() === today.getFullYear() &&
                d.getMonth() === today.getMonth()
            ) {
                monthTotal += amount;
            }
        });

        $("todayTotal").innerText = formatCurrency(todayTotal);
        $("weekTotal").innerText = formatCurrency(weekTotal);
        $("monthTotal").innerText = formatCurrency(monthTotal);
    }

    // ====== MONTH CHART ======
    function renderByMonth() {
        // L·∫•y nƒÉm c·∫ßn hi·ªÉn th·ªã: ∆∞u ti√™n theo √¥ nh·∫≠p, n·∫øu tr·ªëng th√¨ d√πng nƒÉm hi·ªán t·∫°i
        const now = new Date();
        const yearInput = document.getElementById("monthChartYear");
        let year = now.getFullYear();
        if (yearInput && yearInput.value) {
            const parsed = parseInt(yearInput.value, 10);
            if (!isNaN(parsed)) year = parsed;
        } else if (yearInput) {
            yearInput.value = year;
        }

        const monthsExpense = Array(12).fill(0);
        const monthsIncome = Array(12).fill(0);

        expenses.forEach((item) => {
            const d = parseDate(item.date);
            if (d.getFullYear() !== year) return;
            const idx = d.getMonth(); // 0-11
            const amount = Number(item.amount || 0);
            if (isIncome(item)) {
                monthsIncome[idx] += amount;
            } else if (isExpense(item)) {
                monthsExpense[idx] += amount;
            }
        });

        const labels = [
            "Th√°ng 1",
            "Th√°ng 2",
            "Th√°ng 3",
            "Th√°ng 4",
            "Th√°ng 5",
            "Th√°ng 6",
            "Th√°ng 7",
            "Th√°ng 8",
            "Th√°ng 9",
            "Th√°ng 10",
            "Th√°ng 11",
            "Th√°ng 12",
        ];

        if (monthChart) monthChart.destroy();

        const ctx = $("monthChart").getContext("2d");
        monthChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    {
                        label: "Chi ti√™u theo th√°ng (" + year + ")",
                        data: monthsExpense,
                        backgroundColor: "#ef4444",
                    },
                    {
                        label: "Thu nh·∫≠p theo th√°ng (" + year + ")",
                        data: monthsIncome,
                        backgroundColor: "#22c55e",
                    },
                ],
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: "bottom",
                        align: "center",
                        labels: {
                            usePointStyle: true,
                            pointStyle: "rectRounded",
                            padding: 16,
                            boxWidth: 16
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true },
                },
            },
        });

        // T√≥m t·∫Øt s·ªë li·ªáu thu - chi theo nƒÉm
        const totalExpenseYear = monthsExpense.reduce((sum, v) => sum + v, 0);
        const totalIncomeYear = monthsIncome.reduce((sum, v) => sum + v, 0);
        const balanceYear = totalIncomeYear - totalExpenseYear;

        const summaryEl = document.getElementById("monthChartSummary");
        if (summaryEl) {
            summaryEl.textContent =
                "T·ªïng thu nƒÉm " + year + ": " + formatCurrency(totalIncomeYear) +
                " | T·ªïng chi nƒÉm " + year + ": " + formatCurrency(totalExpenseYear) +
                " | S·ªë d∆∞: " + formatCurrency(balanceYear);
        }
    }


    // ====== BUDGET ======
    function getBudgetKey() {
        const mode = $("budgetMode").value;
        if (mode === "day") {
            const v = $("budgetDay").value;
            if (!v) return null;
            return "D:" + v;
        }
        if (mode === "month") {
            const v = $("budgetMonth").value;
            if (!v) return null;
            return "M:" + v;
        }
        if (mode === "year") {
            const v = $("budgetYear").value;
            if (!v) return null;
            return "Y:" + v;
        }
        return null;
    }

    function applyBudgetModeVisibility() {
        const mode = $("budgetMode").value;
        $("budgetPickerDay").style.display = mode === "day" ? "block" : "none";
        $("budgetPickerMonth").style.display =
            mode === "month" ? "block" : "none";
        $("budgetPickerYear").style.display =
            mode === "year" ? "block" : "none";
    }

    function renderBudget() {
        const key = getBudgetKey();
        const labelEl = $("budgetMonthLabel");
        const budgetInput = $("budgetAmount");
        const summary = $("budgetSummary");
        const bar = $("budgetBar");

        if (!key) {
            labelEl.innerText = "Ch∆∞a ch·ªçn th·ªùi gian √°p d·ª•ng ng√¢n s√°ch.";
            budgetInput.value = "";
            summary.innerText = "";
            bar.style.width = "0%";
            bar.style.background = "#9ca3af";
            if (budgetChart) {
                budgetChart.destroy();
                budgetChart = null;
            }
            return;
        }

        const mode = $("budgetMode").value;
        const budgetNum = Number(budgets[key] || 0);

        let labelText = "ƒêang √°p d·ª•ng cho: ";
        if (mode === "day") {
            const v = $("budgetDay").value;
            labelText += formatDateVN(v);
        } else if (mode === "month") {
            const v = $("budgetMonth").value;
            if (v) {
                const [y, m] = v.split("-");
                labelText += "Th√°ng " + m + "/" + y;
            }
        } else if (mode === "year") {
            labelText += "NƒÉm " + $("budgetYear").value;
        }
        labelEl.innerText = labelText;

        // T√≠nh ƒë√£ chi trong kho·∫£ng
        let spent = 0;
        expenses.forEach((item) => {
            if (!isExpense(item)) return;
            const d = parseDate(item.date);
            if (mode === "day") {
                if (item.date === $("budgetDay").value) {
                    spent += Number(item.amount || 0);
                }
            } else if (mode === "month") {
                const v = $("budgetMonth").value;
                if (!v) return;
                const [y, m] = v.split("-");
                if (
                    d.getFullYear() === Number(y) &&
                    d.getMonth() + 1 === Number(m)
                ) {
                    spent += Number(item.amount || 0);
                }
            } else if (mode === "year") {
                const y = Number($("budgetYear").value);
                if (d.getFullYear() === y) {
                    spent += Number(item.amount || 0);
                }
            }
        });

        budgetInput.value = budgetNum ? formatWithDots(String(budgetNum)) : "";

        if (!budgetNum) {
            summary.innerText =
                "Ch∆∞a ƒë·∫∑t ng√¢n s√°ch cho kho·∫£ng th·ªùi gian n√†y. T·ªïng chi hi·ªán t·∫°i: " +
                formatCurrency(spent);
            bar.style.width = "0%";
            bar.style.background = "#9ca3af";
            if (budgetChart) {
                budgetChart.destroy();
                budgetChart = null;
            }
            return;
        }

        const remain = budgetNum - spent;
        let ratio = budgetNum > 0 ? spent / budgetNum : 0;
        if (ratio < 0) ratio = 0;

        summary.innerText =
            "Ng√¢n s√°ch: " +
            formatCurrency(budgetNum) +
            " | ƒê√£ chi: " +
            formatCurrency(spent) +
            " (" +
            Math.round(ratio * 100) +
            "%)" +
            " | C√≤n l·∫°i: " +
            formatCurrency(remain);

        let color = "#22c55e";
        if (ratio >= 0.8 && ratio <= 1) color = "#facc15";
        if (ratio > 1) color = "#ef4444";

        bar.style.background = color;
        bar.style.width = Math.min(ratio * 100, 100) + "%";

        const canvas = $("budgetChart");
        const ctx = canvas.getContext("2d");
        if (budgetChart) budgetChart.destroy();
        budgetChart = new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: ["ƒê√£ chi", "C√≤n l·∫°i"],
                datasets: [
                    {
                        data: [spent, remain > 0 ? remain : 0],
                        backgroundColor: ["#ef4444", "#22c55e"],
                    },
                ],
            },
            options: {
                plugins: {
                    legend: { display: false },
                },
            },
        });

        // Custom legend cho bi·ªÉu ƒë·ªì Ng√¢n s√°ch
        const budgetLegendEl = document.getElementById("budgetLegend");
        if (budgetLegendEl) {
            budgetLegendEl.innerHTML = `
                <div class="legend-item">
                    <span class="legend-color" style="background:#ef4444"></span>
                    <span>ƒê√£ chi</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background:#22c55e"></span>
                    <span>C√≤n l·∫°i</span>
                </div>
            `;
        }
    }

    function saveBudget() {
        const key = getBudgetKey();
        if (!key) {
            showAlert("B·∫°n h√£y ch·ªçn th·ªùi gian √°p d·ª•ng ng√¢n s√°ch tr∆∞·ªõc nh√©!");
            return;
        }

        const valStr = $("budgetAmount").value;
        const valClean = cleanNumericString(valStr);
        const val = Number(valClean);
        if (!val) {
            showAlert("B·∫°n h√£y nh·∫≠p s·ªë ti·ªÅn ng√¢n s√°ch h·ª£p l·ªá nh√©!");
            return;
        }

        budgets[key] = val;
        localStorage.setItem("budgets", JSON.stringify(budgets));
        renderBudget();
        showAlert("ƒê√£ l∆∞u ng√¢n s√°ch!");
    }

    // ====== CRUD GIAO D·ªäCH ======
    function addExpense() {
        let date = $("date").value;
        const amountStr = $("amount").value;
        const amountClean = cleanNumericString(amountStr);
        const amount = Number(amountClean);
        const type = $("type").value;
        const category = $("category").value;
        const note = $("note").value;

        if (!amount) {
            showAlert("B·∫°n h√£y nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá nh√©!");
            return;
        }
        if (!date) date = getTodayString();

        expenses.push({ date, amount, category, note, type });
        localStorage.setItem("expenses", JSON.stringify(expenses));

        $("amount").value = "";
        $("note").value = "";

        renderAll();
    }

    function deleteExpense(index) {
        showConfirm("X√≥a giao d·ªãch n√†y?", () => {
            expenses.splice(index, 1);
            localStorage.setItem("expenses", JSON.stringify(expenses));
            renderAll();
        });
    }

    function clearAllData() {
        showConfirm(
            "B·∫°n c√≥ mu·ªën X√ìA TO√ÄN B·ªò d·ªØ li·ªáu kh√¥ng?<br><strong>H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</strong>",
            () => {
                localStorage.removeItem("expenses");
                localStorage.removeItem("budgets");
                expenses = [];
                budgets = {};
                useAdvancedFilterForPie = false;
                lastAdvancedFilterList = null;

                showAlert("ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu!");
                renderAll();
            }
        );
    }

    function openEditModal(index) {
        editingIndex = index;
        const item = expenses[index];
        $("editDate").value = item.date;
        $("editAmount").value = formatWithDots(String(item.amount || ""));
        $("editType").value = item.type || "Chi ti√™u";
        $("editCategory").value = item.category || "Kh√°c";
        $("editNote").value = item.note || "";
        openModal("editModal");
    }

    function saveEdit() {
        if (editingIndex === null) return;
        let date = $("editDate").value;
        const amountStr = $("editAmount").value;
        const amountClean = cleanNumericString(amountStr);
        const amount = Number(amountClean);
        const type = $("editType").value;
        const category = $("editCategory").value;
        const note = $("editNote").value;

        if (!amount) {
            showAlert("B·∫°n h√£y nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá nh√©!");
            return;
        }
        if (!date) date = getTodayString();

        expenses[editingIndex] = { date, amount, category, note, type };
        localStorage.setItem("expenses", JSON.stringify(expenses));
        closeModal("editModal");
        editingIndex = null;
        renderAll();
    }

    // ====== MODAL HANDLING ======
    function openModal(id) {
        const modal = $(id);
        if (!modal) return;
        modal.style.display = "flex";
    }

    function closeModal(id) {
        const modal = $(id);
        if (!modal) return;
        modal.style.display = "none";
    }

    document.querySelectorAll(".close").forEach((el) => {
        el.addEventListener("click", () => {
            const id = el.dataset.close;
            if (id) closeModal(id);
        });
    });

    document.querySelectorAll(".modal").forEach((modal) => {
        modal.addEventListener("click", (e) => {
            if (e.target === modal) modal.style.display = "none";
        });
    });

    document
        .querySelectorAll("[data-close]")
        .forEach((btn) =>
            btn.addEventListener("click", () => closeModal(btn.dataset.close))
        );

    // ====== EXPORT EXCEL ======
  // ====== EXPORT EXCEL ======
function exportExcel() {
    if (typeof XLSX === "undefined") {
        showAlert(
            "Kh√¥ng t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán xu·∫•t Excel. H√£y ki·ªÉm tra k·∫øt n·ªëi m·∫°ng r·ªìi th·ª≠ l·∫°i."
        );
        return;
    }

    const fromStr = $("exportFrom").value;
    const toStr = $("exportTo").value;

    let filtered;

    if (!fromStr && !toStr) {
        // ‚≠ê Tr∆∞·ªùng h·ª£p ƒë·ªÉ tr·ªëng c·∫£ 2 √¥ ‚Üí xu·∫•t d·ªØ li·ªáu c·ªßa TH√ÅNG HI·ªÜN T·∫†I
        const today = new Date();
        const y = today.getFullYear();
        const m = today.getMonth();          // 0‚Äì11

        const monthStart = new Date(y, m, 1);
        const monthEnd   = new Date(y, m + 1, 0); // ng√†y cu·ªëi th√°ng

        filtered = expenses.filter((item) => {
            const d = parseDate(item.date);
            return d >= monthStart && d <= monthEnd;
        });
    } else {
        // ‚≠ê C√≥ nh·∫≠p √≠t nh·∫•t 1 trong 2 √¥ ‚Üí l·ªçc theo kho·∫£ng ng√†y anh ch·ªçn
        filtered = expenses.filter((item) => {
            const d = parseDate(item.date);
            if (fromStr && d < parseDate(fromStr)) return false;
            if (toStr && d > parseDate(toStr)) return false;
            return true;
        });
    }

    if (!filtered.length) {
        const msg = (!fromStr && !toStr)
            ? "Kh√¥ng c√≥ giao d·ªãch n√†o trong th√°ng hi·ªán t·∫°i ƒë·ªÉ xu·∫•t."
            : "Kh√¥ng c√≥ giao d·ªãch n√†o trong kho·∫£ng th·ªùi gian n√†y ƒë·ªÉ xu·∫•t.";
        showAlert(msg);
        return;
    }

    // T·∫°o d·ªØ li·ªáu cho Excel
    const rows = [
        ["Ng√†y", "S·ªë ti·ªÅn", "Lo·∫°i giao d·ªãch", "Nh√≥m", "Ghi ch√∫"],
    ];

    filtered.forEach((item) => {
        const dateStr = formatDateVN(item.date);
        const amountNum = Number(item.amount || 0);
        const typeLabel =
            item.type || (isExpense(item) ? "Chi ti√™u" : "Thu nh·∫≠p");
        const category = item.category || "";
        const note = item.note || "";
        rows.push([dateStr, amountNum, typeLabel, category, note]);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "GiaoDich");

    const fileName = (!fromStr && !toStr)
        ? "chi_tieu_thang_hien_tai.xlsx"
        : "chi_tieu_" + (fromStr || "ALL") + "_" + (toStr || "ALL") + ".xlsx";

    XLSX.writeFile(wb, fileName);
    closeModal("exportModal");
}


    // ====== FILTER (L·ªåC N√ÇNG CAO) ======
    function applyFilter() {
        const fromStr = $("filterFrom").value;
        const toStr = $("filterTo").value;
        const type = $("filterType").value;
        const category = $("filterCategory").value;

        if (!fromStr || !toStr) {
            showAlert(
                "B·∫°n h√£y ch·ªçn ƒë·∫ßy ƒë·ªß 'T·ª´ ng√†y' v√† 'ƒê·∫øn ng√†y' tr∆∞·ªõc khi √°p d·ª•ng b·ªô l·ªçc nh√©!"
            );
            return;
        }

        let filtered = expenses.filter((item) => {
            const d = parseDate(item.date);

            if (fromStr && d < parseDate(fromStr)) return false;
            if (toStr && d > parseDate(toStr)) return false;

            if (type !== "T·∫•t c·∫£") {
                if (type === "Chi ti√™u" && !isExpense(item)) return false;
                if (type === "Thu nh·∫≠p" && !isIncome(item)) return false;
            }

            if (category !== "T·∫•t c·∫£" && item.category !== category) {
                return false;
            }

            return true;
        });

        const filterSummary = $("filterSummary");
        // Ghi nh·ªõ danh s√°ch n√†y ƒë·ªÉ d√πng cho bi·ªÉu ƒë·ªì khi chuy·ªÉn sang tab B√°o c√°o
        lastAdvancedFilterList = filtered;
        useAdvancedFilterForPie = true;
        const filterList = $("filterList");
        const filterTotals = $("filterTotals");

        if (!filtered.length) {
            filterSummary.innerText = "Kh√¥ng c√≥ giao d·ªãch n√†o ph√π h·ª£p b·ªô l·ªçc.";
            filterList.innerHTML = "";
            filterTotals.innerText = "";
            closeModal("filterModal");

            document
                .querySelector('.tab-btn[data-tab="tab-bao-cao"]')
                .click();
            return;
        }

        let summaryParts = [];
        if (fromStr) summaryParts.push("t·ª´ ng√†y " + formatDateVN(fromStr));
        if (toStr) summaryParts.push("ƒë·∫øn ng√†y " + formatDateVN(toStr));
        if (type !== "T·∫•t c·∫£") summaryParts.push("lo·∫°i: " + type);
        if (category !== "T·∫•t c·∫£") summaryParts.push("nh√≥m: " + category);

        // ƒê·ªìng b·ªô UI L·ªçc bi·ªÉu ƒë·ªì v·ªõi kho·∫£ng ng√†y c·ªßa L·ªçc n√¢ng cao
        // (ch·ªâ ƒë·ªÉ ng∆∞·ªùi d√πng nh√¨n th·∫•y kh·ªõp, vi·ªác v·∫Ω bi·ªÉu ƒë·ªì d√πng customList ƒë√£ l·ªçc ·ªü tr√™n)
        const pieModeSelect = $("pieFilterMode");
        if (pieModeSelect) {
            pieModeSelect.value = "range";
            $("pieFilterYear").style.display = "none";
            $("pieFilterMonth").style.display = "none";
            $("pieFilterRange").style.display = "block";
            if (fromStr) $("pieFrom").value = fromStr;
            if (toStr) $("pieTo").value = toStr;
        }

        filterSummary.innerText =
            "B·ªô l·ªçc: " +
            (summaryParts.length
                ? summaryParts.join(" ")
                : "Kh√¥ng √°p ƒëi·ªÅu ki·ªán.");

        filterList.innerHTML = "";
        let totalIncome = 0;
        let totalExpense = 0;

        const frag = document.createDocumentFragment();

        filtered.forEach((item) => {
            const inc = isIncome(item);
            const sign = inc ? "+" : "-";
            const amountClass = inc ? "amount-income" : "amount-expense";
            const typeLabel = inc ? "Thu nh·∫≠p" : "Chi ti√™u";
            const amount = Number(item.amount || 0);
            const displayDate = formatDateVN(item.date);

            if (inc) totalIncome += amount;
            else totalExpense += amount;

            const row = document.createElement("div");
            row.className = "expense-item";
            row.innerHTML = `
                <div class="expense-main">
                    <div class="${amountClass}">${sign} ${formatCurrency(
                amount
            )}</div>
                    <div class="expense-meta">
                        ${displayDate} ‚Ä¢ ${typeLabel} ‚Ä¢ ${item.category}${
                item.note ? " ‚Ä¢ " + item.note : ""
            }
                    </div>
                </div>
            `;
            frag.appendChild(row);
        });

        filterList.appendChild(frag);

        const balance = totalIncome - totalExpense;
        filterTotals.innerText =
            "T·ªïng thu: " +
            formatCurrency(totalIncome) +
            " | T·ªïng chi: " +
            formatCurrency(totalExpense) +
            " | S·ªë d∆∞: " +
            formatCurrency(balance);

        closeModal("filterModal");
        document.querySelector('.tab-btn[data-tab="tab-bao-cao"]').click();
    }

    // ====== RENDER T·ªîNG H·ª¢P ======
    function updateChartsIfVisible() {
        const reportTabActive =
            $("tab-bao-cao").classList.contains("active");
        const budgetTabActive =
            $("tab-ngan-sach").classList.contains("active");

        if (reportTabActive) {
            if (useAdvancedFilterForPie && lastAdvancedFilterList) {
                renderPieChartFiltered(lastAdvancedFilterList);
            } else {
                renderPieChartFiltered();
            }
            renderByMonth();
        }
        if (budgetTabActive) {
            renderBudget();
            renderQuickStats();
        }
    }

    function renderAll() {
        renderList();
        renderTotal();
        renderQuickStats();
        renderBudget();
        updateChartsIfVisible();
    }

    // ====== INIT ======
    window.onload = function () {
        // Kh·ªüi t·∫°o danh m·ª•c (bao g·ªìm c·∫£ danh m·ª•c t√πy ch·ªânh ƒë√£ l∆∞u)
        refreshCategorySelects();
        // initCategoryNewHandler("category");
        // initCategoryNewHandler("editCategory");

        // auto set ng√†y h√¥m nay
        $("date").value = getTodayString();

        // format s·ªë ti·ªÅn khi nh·∫≠p
        ["amount", "editAmount", "budgetAmount"].forEach((id) => {
            const el = $(id);
            if (!el) return;
            el.addEventListener("input", function () {
                let raw = cleanNumericString(this.value);
                if (!raw) {
                    this.value = "";
                    return;
                }
                raw = String(parseInt(raw, 10));
                if (raw === "NaN") {
                    this.value = "";
                    return;
                }
                this.value = formatWithDots(raw);
            });
        });

        // Kh·ªüi t·∫°o budget picker theo ng√†y hi·ªán t·∫°i
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2, "0");
        const d = String(today.getDate()).padStart(2, "0");
        $("budgetDay").value = `${y}-${m}-${d}`;
        $("budgetMonth").value = `${y}-${m}`;
        $("budgetYear").value = y;

        // Thi·∫øt l·∫≠p nƒÉm m·∫∑c ƒë·ªãnh cho Bi·ªÉu ƒë·ªì Thu - Chi theo t·ª´ng th√°ng
        const monthChartYearInput = document.getElementById("monthChartYear");
        if (monthChartYearInput) {
            monthChartYearInput.value = y;
            monthChartYearInput.addEventListener("change", renderByMonth);
        }



        // ===== M·∫∂C ƒê·ªäNH L·ªåC BI·ªÇU ƒê·ªí = TH√ÅNG HI·ªÜN T·∫†I =====
        const nowPie = new Date();
        const nowYear = nowPie.getFullYear();
        const nowMonth = nowPie.getMonth() + 1; // 1-12

        // ch·ªçn ch·∫ø ƒë·ªô "Theo th√°ng"
        $("pieFilterMode").value = "month";

        // g√°n nƒÉm/th√°ng hi·ªán t·∫°i cho input l·ªçc th√°ng
        $("pieMonthYear").value = nowYear;
        $("pieMonth").value = nowMonth;

        // hi·ªÉn th·ªã ƒë√∫ng kh·ªëi input c·ªßa ch·∫ø ƒë·ªô "Theo th√°ng"
        $("pieFilterYear").style.display = "none";
        $("pieFilterMonth").style.display = "block";
        $("pieFilterRange").style.display = "none";

        // Budget events
        $("budgetMode").addEventListener("change", () => {
            applyBudgetModeVisibility();
            renderBudget();
        });
        ["budgetDay", "budgetMonth", "budgetYear"].forEach((id) => {
            $(id).addEventListener("change", renderBudget);
        });
        applyBudgetModeVisibility();

        // Overview events
        $("overviewModeSelect").addEventListener("change", (e) =>
            setOverviewMode(e.target.value)
        );
        ["overviewDay", "overviewMonth", "overviewYear", "overviewFrom", "overviewTo"]
            .forEach((id) => $(id).addEventListener("change", renderTotal));

        // Pie filter UI
        $("pieFilterMode").addEventListener("change", () => {
            // Ng∆∞·ªùi d√πng t·ª± ƒë·ªïi Ch·∫ø ƒë·ªô l·ªçc bi·ªÉu ƒë·ªì => kh√¥ng c√≤n d√πng L·ªçc n√¢ng cao
            useAdvancedFilterForPie = false;
            lastAdvancedFilterList = null;
            $("pieFilterYear").style.display = "none";
            $("pieFilterMonth").style.display = "none";
            $("pieFilterRange").style.display = "none";

            const mode = $("pieFilterMode").value;
            if (mode === "year") $("pieFilterYear").style.display = "block";
            if (mode === "month") $("pieFilterMonth").style.display = "block";
            if (mode === "range") $("pieFilterRange").style.display = "block";

            renderPieChartFiltered();
        });

        ["pieYear", "pieMonthYear", "pieMonth", "pieFrom", "pieTo"].forEach(
            (id) => {
                $(id).addEventListener("change", renderPieChartFiltered);
            }
        );

        // Buttons
        $("btnAdd").addEventListener("click", addExpense);
        $("btnClearAll").addEventListener("click", clearAllData);
        $("btnExport").addEventListener("click", () => openModal("exportModal"));
        $("btnExportConfirm").addEventListener("click", exportExcel);
        $("btnFilterQuick").addEventListener("click", () =>
            openModal("filterModal")
        );
        $("btnApplyFilter").addEventListener("click", applyFilter);
        $("btnSaveEdit").addEventListener("click", saveEdit);
        $("btnSaveBudget").addEventListener("click", saveBudget);

        renderAll();
    };
</script>
<!-- Popup alert/confirm -->
<div class="app-alert-overlay" id="appAlertOverlay">
<div class="app-alert-dialog">
<div class="app-alert-message" id="appAlertMessage"></div>
<div class="app-alert-actions">
<button class="app-alert-button app-alert-button-secondary" id="appAlertCancel">H·ªßy</button>
<button class="app-alert-button" id="appAlertOk">OK</button>
</div>
</div>
</div>
</body>
</html>
